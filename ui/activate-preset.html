<!DOCTYPE html>
<html>

<head lang="en">
  <title>Activate Preset Settings</title>
  <meta charset="utf-8" />
  <script src="https://sdpi-components.dev/releases/v4/sdpi-components.js"></script>
  <style>
    .controller-row {
      display: flex;
      align-items: flex-start;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .controller-row:last-child {
      border-bottom: none;
    }
    .controller-row input[type="checkbox"] {
      margin-top: 2px;
      margin-right: 8px;
      flex-shrink: 0;
    }
    .controller-label {
      flex: 1;
      overflow: hidden;
    }
    .controller-name {
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .controller-ip {
      font-size: 0.85em;
      opacity: 0.7;
    }
    .empty-message {
      font-size: 0.85em;
      opacity: 0.7;
      font-style: italic;
    }
    .empty-hint {
      font-size: 0.8em;
      opacity: 0.6;
      margin-top: 4px;
    }
    .mode-row {
      display: flex;
      align-items: center;
      padding: 6px 0;
    }
    .mode-row input[type="checkbox"] {
      margin-right: 8px;
      flex-shrink: 0;
    }
    .preset-section {
      margin-top: 4px;
    }
    .preset-row {
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .preset-row:last-child {
      border-bottom: none;
    }
    .preset-label {
      display: block;
      font-size: 0.85em;
      opacity: 0.8;
      margin-bottom: 4px;
    }
    .preset-select {
      width: 100%;
      background: #1a1a1a;
      color: #e8e8e8;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 0.9em;
    }
    .preset-select:focus {
      outline: none;
      border-color: rgba(255,255,255,0.4);
    }
    .preset-error {
      font-size: 0.8em;
      color: #ff6b6b;
      margin-top: 2px;
    }
    .add-form {
      margin-top: 4px;
    }
    .add-form input {
      width: 100%;
      box-sizing: border-box;
      background: #1a1a1a;
      color: #e8e8e8;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 0.9em;
      margin-bottom: 4px;
    }
    .add-form input:focus {
      outline: none;
      border-color: rgba(255,255,255,0.4);
    }
  </style>
</head>

<body>
  <sdpi-item label="Target Controllers">
    <div id="controller-list">
      <div class="empty-message">Loading controllers...</div>
    </div>
  </sdpi-item>

  <sdpi-item label="Add Controller">
    <div class="add-form">
      <input type="text" id="input-ip" placeholder="192.168.1.50 or hostname:port" />
      <input type="text" id="input-name" placeholder="Display name (optional)" />
      <sdpi-button id="btn-add">Add</sdpi-button>
    </div>
  </sdpi-item>

  <sdpi-item label="Advanced Mode" id="mode-section" style="display:none">
    <div class="mode-row">
      <input type="checkbox" id="advanced-mode-toggle">
      <label for="advanced-mode-toggle">Per-controller presets</label>
    </div>
  </sdpi-item>

  <sdpi-item label="Preset" id="preset-section" style="display:none">
    <div id="preset-container">
      <!-- Populated by renderPresets() -->
    </div>
  </sdpi-item>

  <script>
    // Current state
    let currentControllers = [];
    let currentSettings = {
      controllerIds: [],
      presetId: null,
      advancedMode: false,
      controllerPresets: {}
    };
    // Map of controllerId -> WLEDPreset[]
    let presetsByController = {};

    function escHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    /**
     * Returns the list of currently selected controller IDs from the DOM.
     */
    function getCheckedControllerIds() {
      return Array.from(
        document.querySelectorAll('#controller-list input[type="checkbox"]:checked')
      ).map((cb) => cb.getAttribute('data-controller-id'));
    }

    /**
     * Render the checkbox list for all controllers.
     * Pre-checks boxes matching currentSettings.controllerIds.
     */
    function renderControllerList() {
      const container = document.getElementById('controller-list');

      if (!currentControllers.length) {
        container.innerHTML =
          '<div class="empty-message">No controllers registered.</div>' +
          '<div class="empty-hint">Add a controller below by IP address.</div>';
        // Hide mode and preset sections
        document.getElementById('mode-section').style.display = 'none';
        document.getElementById('preset-section').style.display = 'none';
        return;
      }

      const checkedIds = new Set(currentSettings.controllerIds || []);

      container.innerHTML = currentControllers.map((c) => {
        const checked = checkedIds.has(c.id) ? 'checked' : '';
        return `
          <div class="controller-row">
            <input type="checkbox" id="cb-${escHtml(c.id)}" data-controller-id="${escHtml(c.id)}" ${checked}>
            <label for="cb-${escHtml(c.id)}" class="controller-label">
              <div class="controller-name">${escHtml(c.name)}</div>
              <div class="controller-ip">${escHtml(c.ip)}</div>
            </label>
          </div>
        `;
      }).join('');

      // Auto-save and refresh presets on any checkbox change
      container.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
        cb.addEventListener('change', onControllerCheckboxChange);
      });

      updateSectionVisibility();
    }

    /**
     * Called when a controller checkbox changes.
     * Saves settings and fetches presets for newly checked controllers.
     */
    function onControllerCheckboxChange(event) {
      const cb = event.target;
      const controllerId = cb.getAttribute('data-controller-id');
      if (cb.checked && !presetsByController[controllerId]) {
        requestPresets(controllerId);
      }
      saveSettings();
      updateSectionVisibility();
      renderPresets();
    }

    /**
     * Update visibility of mode and preset sections based on selection state.
     */
    function updateSectionVisibility() {
      const checkedIds = getCheckedControllerIds();
      const modeSection = document.getElementById('mode-section');
      const presetSection = document.getElementById('preset-section');

      if (checkedIds.length > 0) {
        modeSection.style.display = '';
        presetSection.style.display = '';
      } else {
        modeSection.style.display = 'none';
        presetSection.style.display = 'none';
      }
    }

    /**
     * Render the preset dropdown(s).
     * In simple mode: one dropdown for the first selected controller.
     * In advanced mode: one dropdown per selected controller.
     */
    function renderPresets() {
      const checkedIds = getCheckedControllerIds();
      const advancedMode = document.getElementById('advanced-mode-toggle').checked;
      const container = document.getElementById('preset-container');

      if (checkedIds.length === 0) {
        container.innerHTML = '';
        return;
      }

      if (advancedMode) {
        // Advanced mode: one dropdown per selected controller
        container.innerHTML = checkedIds.map((cid) => {
          const controller = currentControllers.find((c) => c.id === cid);
          const label = controller ? escHtml(controller.name) : escHtml(cid);
          const savedPresetId = currentSettings.controllerPresets[cid];
          const raw = presetsByController[cid];
          const presets = raw && raw.error ? [] : raw;
          const error = raw && raw.error ? raw.error : null;
          return buildPresetDropdown(cid, label, cid, presets, savedPresetId, error);
        }).join('');
      } else {
        // Simple mode: one dropdown for the first selected controller
        const firstCid = checkedIds[0];
        const savedPresetId = currentSettings.presetId;
        const raw = presetsByController[firstCid];
        const presets = raw && raw.error ? [] : raw;
        const error = raw && raw.error ? raw.error : null;
        container.innerHTML = buildPresetDropdown('simple', null, firstCid, presets, savedPresetId, error);
      }

      // Attach change listeners
      container.querySelectorAll('select.preset-select').forEach((sel) => {
        sel.addEventListener('change', saveSettings);
      });
    }

    /**
     * Build HTML for a preset dropdown.
     * @param {string} selectId - unique id for the <select> element
     * @param {string|null} label - label text, or null for no label
     * @param {string} controllerId - data attribute value
     * @param {Array|undefined} presets - preset array (undefined = still loading)
     * @param {number|null} savedValue - currently saved preset ID to pre-select
     * @param {string|null} error - error text if fetch failed
     */
    function buildPresetDropdown(selectId, label, controllerId, presets, savedValue, error) {
      let optionsHtml;
      if (presets === undefined) {
        optionsHtml = '<option value="" disabled selected>Loading presets...</option>';
      } else if (error) {
        optionsHtml = `<option value="" disabled selected>Error: ${escHtml(error)}</option>`;
      } else if (presets.length === 0) {
        optionsHtml = '<option value="" disabled selected>No presets on this device</option>';
      } else {
        const defaultOpt = '<option value="">-- Select a preset --</option>';
        const presetOpts = presets.map((p) => {
          const selected = (savedValue !== null && savedValue !== undefined && p.id === savedValue) ? 'selected' : '';
          return `<option value="${p.id}" ${selected}>${escHtml(p.name)}</option>`;
        }).join('');
        optionsHtml = defaultOpt + presetOpts;
      }

      const labelHtml = label ? `<span class="preset-label">${label}</span>` : '';
      return `
        <div class="preset-row">
          ${labelHtml}
          <select id="preset-select-${escHtml(selectId)}" class="preset-select" data-controller-id="${escHtml(controllerId)}">
            ${optionsHtml}
          </select>
        </div>
      `;
    }

    /**
     * Collect current state and send ap:saveSettings to plugin.
     */
    function saveSettings() {
      const checkedIds = getCheckedControllerIds();
      const advancedMode = document.getElementById('advanced-mode-toggle').checked;

      let presetId = null;
      const controllerPresets = {};

      if (advancedMode) {
        // Collect per-controller preset selections
        document.querySelectorAll('#preset-container select.preset-select').forEach((sel) => {
          const cid = sel.getAttribute('data-controller-id');
          const val = sel.value;
          if (val !== '') {
            controllerPresets[cid] = Number(val);
          }
        });
      } else {
        // Collect single preset selection
        const simpleSelect = document.getElementById('preset-select-simple');
        if (simpleSelect && simpleSelect.value !== '') {
          presetId = Number(simpleSelect.value);
        }
      }

      currentSettings = {
        controllerIds: checkedIds,
        presetId,
        advancedMode,
        controllerPresets
      };

      if (window.$SD) {
        window.$SD.send('sendToPlugin', {
          type: 'ap:saveSettings',
          controllerIds: checkedIds,
          presetId,
          advancedMode,
          controllerPresets
        });
      }
    }

    /**
     * Request preset list for a given controller from the plugin.
     */
    function requestPresets(controllerId) {
      if (window.$SD) {
        window.$SD.send('sendToPlugin', { type: 'ap:getPresets', controllerId });
      }
    }

    /**
     * Request initial controller list from plugin.
     */
    function requestControllers() {
      if (window.$SD) {
        window.$SD.send('sendToPlugin', { type: 'ap:getControllers' });
      }
    }

    /**
     * Handle mode toggle change.
     */
    document.addEventListener('DOMContentLoaded', () => {
      const modeToggle = document.getElementById('advanced-mode-toggle');
      modeToggle.addEventListener('change', () => {
        saveSettings();
        renderPresets();
      });
    });

    // Add controller button handler
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btn-add').addEventListener('click', () => {
        const ipEl = document.getElementById('input-ip');
        const nameEl = document.getElementById('input-name');
        const ip = (ipEl.value || '').trim();
        const name = (nameEl.value || '').trim();
        if (!ip) return;
        if (window.$SD) {
          // Non-namespaced — handled by the global onSendToPlugin handler
          window.$SD.send('sendToPlugin', { type: 'addController', ip, name: name || undefined });
        }
        ipEl.value = '';
        nameEl.value = '';
      });
    });

    // On DOMContentLoaded: try requesting immediately (may not have $SD yet)
    document.addEventListener('DOMContentLoaded', () => {
      requestControllers();
    });

    // On websocketCreate: $SD is now available — request controllers and listen for messages
    document.addEventListener('websocketCreate', () => {
      // Request controllers now that bridge is ready
      window.$SD.send('sendToPlugin', { type: 'ap:getControllers' });

      window.$SD.on('sendToPropertyInspector', (event) => {
        const msg = event.payload;
        if (!msg || !msg.type) return;

        if (msg.type === 'init') {
          // Initial load: store controllers and settings, then render
          currentControllers = msg.controllers || [];
          currentSettings = msg.settings || {
            controllerIds: [],
            presetId: null,
            advancedMode: false,
            controllerPresets: {}
          };
          // Set advanced mode toggle state
          document.getElementById('advanced-mode-toggle').checked = Boolean(currentSettings.advancedMode);
          renderControllerList();
          renderPresets();
          // Request presets for all currently selected controllers
          const checkedIds = currentSettings.controllerIds || [];
          checkedIds.forEach((cid) => requestPresets(cid));
        } else if (msg.type === 'controllerList') {
          // Updated controller list — re-render preserving current checked state
          currentControllers = msg.controllers || [];
          renderControllerList();
          renderPresets();
        } else if (msg.type === 'presetList') {
          // Store presets for the given controller
          const cid = msg.controllerId;
          if (msg.error) {
            presetsByController[cid] = { error: msg.error, presets: [] };
          } else {
            presetsByController[cid] = msg.presets || [];
          }
          renderPresets();
        }
      });
    });
  </script>
</body>

</html>
