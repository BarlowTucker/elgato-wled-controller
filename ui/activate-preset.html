<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WLED Activate Preset</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 12px; color: #e8e8e8; background: transparent; padding: 8px; overflow-x: hidden; }
    .section-label { font-size: 11px; font-weight: 600; color: #969696; text-transform: uppercase; letter-spacing: 0.5px; margin: 12px 0 6px 0; }
    .section-label:first-child { margin-top: 0; }
    .row { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
    .row label { flex: 0 0 70px; font-size: 11px; color: #969696; }
    input[type="text"], input[type="number"], select {
      flex: 1; min-width: 0; background: #2d2d2d; border: 1px solid #3d3d3d; border-radius: 3px;
      color: #e8e8e8; padding: 4px 6px; font-size: 12px; outline: none;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus { border-color: #0077ff; }
    button {
      background: #0077ff; color: #fff; border: none; border-radius: 3px;
      padding: 4px 10px; font-size: 12px; cursor: pointer; white-space: nowrap;
    }
    button:hover { background: #0066dd; }
    button.danger { background: #c0392b; }
    button.danger:hover { background: #a93226; }
    .controller-list { display: flex; flex-direction: column; gap: 4px; margin-bottom: 6px; }
    .controller-item {
      display: flex; align-items: center; gap: 6px;
      background: #2d2d2d; border-radius: 3px; padding: 4px 8px;
    }
    .controller-name { flex: 1; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .controller-ip { font-size: 10px; color: #969696; white-space: nowrap; }
    .checkbox-list { display: flex; flex-direction: column; gap: 4px; }
    .checkbox-item { display: flex; align-items: center; gap: 6px; }
    .checkbox-item label { font-size: 12px; cursor: pointer; }
    .no-controllers { font-size: 11px; color: #666; font-style: italic; }
    .hint { font-size: 10px; color: #666; margin-top: 2px; }
    hr { border: none; border-top: 1px solid #333; margin: 10px 0; }
    .manage-btn {
      display: flex; align-items: center; justify-content: space-between; width: 100%;
      background: #2d2d2d; border: 1px solid #3d3d3d; color: #e8e8e8; border-radius: 3px;
      padding: 6px 10px; font-size: 12px; cursor: pointer; margin-bottom: 8px;
    }
    .manage-btn:hover { background: #363636; border-color: #4d4d4d; }
    .manage-btn .arrow { font-size: 10px; color: #969696; }
    .manage-panel { display: none; border: 1px solid #3d3d3d; border-radius: 3px; padding: 8px; margin-bottom: 8px; background: #1e1e1e; }
    .manage-panel.open { display: block; }
    .validation-error { font-size: 10px; color: #c0392b; margin: 2px 0 4px 0; display: none; }
    input.invalid { border-color: #c0392b !important; }
  </style>
</head>
<body>

  <!-- Controller Management Toggle -->
  <button class="manage-btn" id="manage-toggle">
    <span>Manage Controllers</span>
    <span class="arrow" id="manage-arrow">&#9660;</span>
  </button>
  <div class="manage-panel" id="manage-panel">
    <div class="row">
      <input type="text" id="ctrl-ip" placeholder="IP address" pattern="^(\d{1,3}\.){3}\d{1,3}$" />
      <input type="text" id="ctrl-name" placeholder="Name" style="flex: 0.7" />
      <button id="btn-add">Add</button>
    </div>
    <div class="validation-error" id="ip-error">Enter a valid IP address (e.g. 192.168.1.100)</div>
    <div class="controller-list" id="controller-list">
      <div class="no-controllers">No controllers added yet.</div>
    </div>
  </div>

  <!-- Target Selection -->
  <div class="section-label">Target Controllers</div>
  <div class="checkbox-list" id="checkbox-list">
    <div class="no-controllers">No controllers — click Manage Controllers to add.</div>
  </div>

  <hr />

  <!-- Preset ID -->
  <div class="section-label">Preset</div>
  <div class="row">
    <label>Preset ID</label>
    <input type="number" id="preset-id" min="1" max="250" placeholder="1-250" />
  </div>
  <div class="hint">Enter a numeric preset ID (1-250). Activating also powers on.</div>

  <script src="sdpi-components.js"></script>
  <script>
  (function() {
    var controllers = [];
    var actionSettings = { selectedControllers: [], presetId: null };

    function renderControllerList() {
      var list = document.getElementById("controller-list");
      if (controllers.length === 0) {
        list.innerHTML = '<div class="no-controllers">No controllers added yet.</div>';
        return;
      }
      list.innerHTML = controllers.map(function(c) { return ''
        + '<div class="controller-item">'
        + '<span class="controller-name">' + escHtml(c.name) + '</span>'
        + '<span class="controller-ip">' + escHtml(c.ip) + '</span>'
        + '<button class="danger" data-ip="' + escHtml(c.ip) + '">Remove</button>'
        + '</div>';
      }).join("");
      list.querySelectorAll("button[data-ip]").forEach(function(btn) {
        btn.addEventListener("click", function() { removeController(btn.dataset.ip); });
      });
    }

    function renderCheckboxes() {
      var list = document.getElementById("checkbox-list");
      if (controllers.length === 0) {
        list.innerHTML = '<div class="no-controllers">No controllers — click Manage Controllers to add.</div>';
        return;
      }
      list.innerHTML = controllers.map(function(c) { return ''
        + '<div class="checkbox-item">'
        + '<input type="checkbox" id="chk-' + escHtml(c.ip) + '" value="' + escHtml(c.ip) + '"'
        + (actionSettings.selectedControllers.indexOf(c.ip) !== -1 ? ' checked' : '') + ' />'
        + '<label for="chk-' + escHtml(c.ip) + '">' + escHtml(c.name) + ' (' + escHtml(c.ip) + ')</label>'
        + '</div>';
      }).join("");
      list.querySelectorAll("input[type=checkbox]").forEach(function(chk) {
        chk.addEventListener("change", saveSettings);
      });
    }

    function refreshUI() {
      renderControllerList();
      renderCheckboxes();
    }

    var IP_PATTERN = /^(\d{1,3}\.){3}\d{1,3}$/;

    function isValidIp(ip) {
      if (!IP_PATTERN.test(ip)) return false;
      return ip.split(".").every(function(n) { return parseInt(n, 10) <= 255; });
    }

    function escHtml(str) {
      return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    async function saveSettings() {
      var selectedControllers = Array.from(
        document.querySelectorAll("#checkbox-list input[type=checkbox]:checked")
      ).map(function(chk) { return chk.value; });
      var rawPreset = document.getElementById("preset-id").value;
      var presetId = rawPreset === "" ? null : parseInt(rawPreset, 10);
      actionSettings = { selectedControllers: selectedControllers, presetId: presetId };
      await streamDeck.settings.setSettings(actionSettings);
    }

    async function addController() {
      var ipInput = document.getElementById("ctrl-ip");
      var ipError = document.getElementById("ip-error");
      var ip = ipInput.value.trim();
      var name = document.getElementById("ctrl-name").value.trim();
      if (!ip || !name) return;
      if (!isValidIp(ip)) {
        ipInput.classList.add("invalid");
        ipError.style.display = "block";
        return;
      }
      ipInput.classList.remove("invalid");
      ipError.style.display = "none";
      var globals = await streamDeck.settings.getGlobalSettings();
      var list = (globals && globals.controllers) || [];
      if (!list.some(function(c) { return c.ip === ip; })) {
        list = list.concat([{ ip: ip, name: name }]);
        await streamDeck.settings.setGlobalSettings({ controllers: list });
      }
      controllers = list;
      refreshUI();
      document.getElementById("ctrl-ip").value = "";
      document.getElementById("ctrl-name").value = "";
    }

    async function removeController(ip) {
      var globals = await streamDeck.settings.getGlobalSettings();
      var list = ((globals && globals.controllers) || []).filter(function(c) { return c.ip !== ip; });
      await streamDeck.settings.setGlobalSettings({ controllers: list });
      controllers = list;
      refreshUI();
    }

    streamDeck.settings.onDidReceiveGlobalSettings(function(ev) {
      controllers = (ev.settings && ev.settings.controllers) || [];
      refreshUI();
    });

    // Collapsible panel toggle
    var managePanel = document.getElementById("manage-panel");
    var manageArrow = document.getElementById("manage-arrow");
    document.getElementById("manage-toggle").addEventListener("click", function() {
      var isOpen = managePanel.classList.toggle("open");
      manageArrow.innerHTML = isOpen ? "&#9650;" : "&#9660;";
    });

    document.getElementById("btn-add").addEventListener("click", addController);
    document.getElementById("ctrl-ip").addEventListener("keydown", function(e) {
      if (e.key === "Enter") document.getElementById("ctrl-name").focus();
    });
    document.getElementById("ctrl-name").addEventListener("keydown", function(e) {
      if (e.key === "Enter") addController();
    });
    document.getElementById("preset-id").addEventListener("change", saveSettings);
    document.getElementById("preset-id").addEventListener("input", saveSettings);

    streamDeck.settings.getGlobalSettings().then(function(g) {
      controllers = (g && g.controllers) || [];
      refreshUI();
    }).catch(function() {});

    streamDeck.settings.getSettings().then(function(s) {
      if (s) {
        actionSettings = {
          selectedControllers: s.selectedControllers || [],
          presetId: s.presetId || null
        };
        if (actionSettings.presetId) {
          document.getElementById("preset-id").value = actionSettings.presetId;
        }
        refreshUI();
      }
    }).catch(function() {});
  })();
  </script>
</body>
</html>
