<!DOCTYPE html>
<html>

<head lang="en">
  <title>WLED Controller Settings</title>
  <meta charset="utf-8" />
  <script src="https://sdpi-components.dev/releases/v4/sdpi-components.js"></script>
  <style>
    .controller-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .controller-info {
      flex: 1;
      overflow: hidden;
    }
    .controller-name {
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .controller-ip {
      font-size: 0.85em;
      opacity: 0.7;
    }
    .controller-status {
      font-size: 0.8em;
      margin: 0 8px;
      white-space: nowrap;
    }
    .status-online { color: #4caf50; }
    .status-offline { color: #f44336; }
    .scan-result-row {
      display: flex;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .scan-result-row.already-registered {
      opacity: 0.5;
    }
    .scan-result-row input[type="checkbox"] {
      margin-right: 8px;
    }
    .note {
      font-size: 0.8em;
      opacity: 0.6;
      margin-top: 4px;
    }
    .empty-message {
      font-size: 0.85em;
      opacity: 0.7;
      font-style: italic;
    }
    .section-label {
      font-weight: bold;
      margin-bottom: 4px;
    }
  </style>
</head>

<body>
  <!-- SECTION 1: Scan for Devices (top) -->
  <sdpi-item label="Scan">
    <div>
      <sdpi-button id="btn-scan">Scan for Devices</sdpi-button>
      <span id="scan-status" style="display:none; margin-left:8px; font-size:0.85em; opacity:0.7;">Scanning...</span>
    </div>
  </sdpi-item>

  <sdpi-item label="Scan Results" id="scan-results-section" style="display:none;">
    <div id="scan-results-list"></div>
    <div style="margin-top:6px;">
      <sdpi-button id="btn-add-selected" disabled>Add Selected</sdpi-button>
    </div>
  </sdpi-item>

  <!-- SECTION 2: Controller list (middle) -->
  <sdpi-item label="Controllers">
    <div id="controller-list">
      <div class="empty-message">No controllers added yet.</div>
    </div>
    <div class="note">Removing a controller may affect actions that reference it.</div>
  </sdpi-item>

  <!-- SECTION 3: Manual add form (bottom) -->
  <sdpi-item label="Add by IP">
    <sdpi-textfield
      id="input-ip"
      placeholder="192.168.1.50 or 192.168.1.50:8080"
    ></sdpi-textfield>
    <sdpi-textfield
      id="input-name"
      placeholder="Desk Strip (optional)"
      style="margin-top:4px;"
    ></sdpi-textfield>
    <sdpi-button id="btn-add" style="margin-top:4px;">Add Controller</sdpi-button>
  </sdpi-item>

  <script>
    // Store scan results for selection
    let scanResults = [];

    // Helper: get SD PI websocket bridge
    function sendToPlugin(payload) {
      if (window.sendToPlugin) {
        window.sendToPlugin(payload);
      } else {
        // sdpi-components v4 exposes connectElgatoStreamDeckSocket
        // The bridge is set up via the websocket registered at startup
        document.dispatchEvent(new CustomEvent('sendToPlugin', { detail: payload }));
      }
    }

    // Use the sdpi-components event bridge
    document.addEventListener('DOMContentLoaded', () => {
      // Request initial controller list when PI opens
      const requestControllers = () => {
        if (window.$SD) {
          window.$SD.send('sendToPlugin', { type: 'getControllers' });
        }
      };

      // Try immediately and also after SD initializes
      requestControllers();
    });

    // Listen for messages from the plugin via sdpi-components bridge
    document.addEventListener('websocketCreate', () => {
      window.$SD.on('sendToPropertyInspector', (event) => {
        const msg = event.payload;
        if (!msg || !msg.type) return;

        if (msg.type === 'controllerList') {
          renderControllerList(msg.controllers || [], msg.onlineStatus || {});
          // Request was fulfilled — also refresh scan results to grey out newly added devices
          if (scanResults.length > 0) {
            renderScanResults(scanResults, msg.controllers || []);
          }
        } else if (msg.type === 'scanResults') {
          const controllers = getCurrentControllerIps();
          renderScanResults(msg.devices || [], controllers);
          document.getElementById('scan-results-section').style.display = '';
        } else if (msg.type === 'scanComplete') {
          document.getElementById('btn-scan').removeAttribute('disabled');
          document.getElementById('scan-status').style.display = 'none';
        }
      });

      // Request controllers on PI open
      window.$SD.send('sendToPlugin', { type: 'getControllers' });
    });

    // Track current registered IPs for scan result greying
    let registeredIps = new Set();

    function getCurrentControllerIps() {
      return registeredIps;
    }

    function renderControllerList(controllers, onlineStatus) {
      registeredIps = new Set(controllers.map(c => c.ip));
      const container = document.getElementById('controller-list');

      if (!controllers.length) {
        container.innerHTML = '<div class="empty-message">No controllers added yet.</div>';
        return;
      }

      container.innerHTML = controllers.map(c => {
        const isOnline = onlineStatus[c.id];
        const statusClass = isOnline ? 'status-online' : 'status-offline';
        const statusText = isOnline ? '[Online]' : '[Offline]';
        return `
          <div class="controller-row">
            <div class="controller-info">
              <div class="controller-name" title="${escHtml(c.name)}">${escHtml(c.name)}</div>
              <div class="controller-ip">${escHtml(c.ip)}</div>
            </div>
            <span class="controller-status ${statusClass}">${statusText}</span>
            <sdpi-button data-remove-id="${escHtml(c.id)}">Remove</sdpi-button>
          </div>
        `;
      }).join('');

      // Attach remove handlers
      container.querySelectorAll('[data-remove-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-remove-id');
          window.$SD.send('sendToPlugin', { type: 'removeController', id });
        });
      });
    }

    function renderScanResults(devices, controllers) {
      scanResults = devices;
      const registeredSet = controllers instanceof Set ? controllers : new Set(
        Array.isArray(controllers) ? controllers.map(c => c.ip) : []
      );
      const container = document.getElementById('scan-results-list');

      if (!devices.length) {
        container.innerHTML = '<div class="empty-message">No WLED devices found on your network. Try adding by IP below.</div>';
        document.getElementById('btn-add-selected').setAttribute('disabled', 'true');
        return;
      }

      container.innerHTML = devices.map((d, i) => {
        const alreadyReg = registeredSet.has(d.ip);
        const rowClass = alreadyReg ? 'scan-result-row already-registered' : 'scan-result-row';
        const cbDisabled = alreadyReg ? 'disabled' : '';
        const cbChecked = alreadyReg ? 'checked' : '';
        return `
          <div class="${rowClass}">
            <input type="checkbox" id="scan-cb-${i}" ${cbChecked} ${cbDisabled} data-scan-ip="${escHtml(d.ip)}" data-scan-name="${escHtml(d.name)}">
            <label for="scan-cb-${i}">
              <strong>${escHtml(d.name)}</strong> — ${escHtml(d.ip)}${alreadyReg ? ' (already added)' : ''}
            </label>
          </div>
        `;
      }).join('');

      // Enable add-selected if any unchecked items
      const hasSelectable = devices.some(d => !registeredSet.has(d.ip));
      if (hasSelectable) {
        document.getElementById('btn-add-selected').removeAttribute('disabled');
      } else {
        document.getElementById('btn-add-selected').setAttribute('disabled', 'true');
      }

      // Update checked state on change
      container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', updateAddSelectedState);
      });
    }

    function updateAddSelectedState() {
      const anyChecked = document.querySelectorAll('#scan-results-list input[type="checkbox"]:not([disabled]):checked').length > 0;
      const btn = document.getElementById('btn-add-selected');
      if (anyChecked) {
        btn.removeAttribute('disabled');
      } else {
        btn.setAttribute('disabled', 'true');
      }
    }

    function escHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // Scan button
    document.getElementById('btn-scan').addEventListener('click', () => {
      document.getElementById('btn-scan').setAttribute('disabled', 'true');
      document.getElementById('scan-status').style.display = '';
      document.getElementById('scan-results-section').style.display = 'none';
      document.getElementById('scan-results-list').innerHTML = '';
      window.$SD.send('sendToPlugin', { type: 'scan' });
    });

    // Add selected discovered devices
    document.getElementById('btn-add-selected').addEventListener('click', () => {
      const checked = document.querySelectorAll('#scan-results-list input[type="checkbox"]:not([disabled]):checked');
      const devices = Array.from(checked).map(cb => ({
        ip: cb.getAttribute('data-scan-ip'),
        name: cb.getAttribute('data-scan-name'),
      }));
      if (devices.length > 0) {
        window.$SD.send('sendToPlugin', { type: 'addDiscovered', devices });
      }
    });

    // Manual add form
    document.getElementById('btn-add').addEventListener('click', () => {
      const ipEl = document.getElementById('input-ip');
      const nameEl = document.getElementById('input-name');
      const ip = (ipEl.value || '').trim();
      const name = (nameEl.value || '').trim();
      if (!ip) return;
      window.$SD.send('sendToPlugin', { type: 'addController', ip, name: name || undefined });
      // Clear form fields after submitting
      ipEl.value = '';
      nameEl.value = '';
    });
  </script>
</body>

</html>
