---
phase: 02-actions
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/actions/ActivatePresetAction.ts
  - ui/activate-preset.html
  - src/plugin.ts
  - manifest.json
  - imgs/actions/activate-preset/icon.png
  - imgs/actions/activate-preset/key.png
autonomous: true
requirements:
  - BTN-02
  - BTN-03
  - BTN-04
  - CTRL-04
  - CTRL-05
  - UI-01

must_haves:
  truths:
    - "User can press a button to activate a specific WLED preset on all selected controllers"
    - "User can configure different presets per controller in advanced mode"
    - "Property Inspector shows preset names fetched from WLED, not raw numeric IDs"
    - "User can select which controllers the preset action targets via multi-select"
    - "When a targeted controller is unreachable during preset activation, the key shows an alert without crashing"
    - "Activate Preset action appears in the Stream Deck action list"
  artifacts:
    - path: "src/actions/ActivatePresetAction.ts"
      provides: "Activate preset action with simple and advanced mode fan-out"
      exports: ["ActivatePresetAction"]
    - path: "ui/activate-preset.html"
      provides: "Property Inspector with controller select, preset dropdown, and advanced mode toggle"
      min_lines: 80
  key_links:
    - from: "src/actions/ActivatePresetAction.ts"
      to: "src/client/WLEDClient.ts"
      via: "WLEDClient.fromHostPort().setState({ ps: presetId })"
      pattern: "setState.*ps"
    - from: "src/actions/ActivatePresetAction.ts"
      to: "src/client/WLEDClient.ts"
      via: "WLEDClient.fromHostPort().getPresets() for PI preset list"
      pattern: "getPresets"
    - from: "src/actions/ActivatePresetAction.ts"
      to: "src/registry/ControllerRegistry.ts"
      via: "ControllerRegistry.getInstance().getById()"
      pattern: "registry\\.getById"
    - from: "src/plugin.ts"
      to: "src/actions/ActivatePresetAction.ts"
      via: "streamDeck.actions.registerAction()"
      pattern: "registerAction.*ActivatePresetAction"
    - from: "manifest.json"
      to: "ui/activate-preset.html"
      via: "PropertyInspectorPath in Actions array"
      pattern: "activate-preset\\.html"
---

<objective>
Add the Activate Preset action — users press a button to apply a WLED preset to their controllers. Supports both simple mode (same preset for all controllers) and advanced mode (per-controller preset mapping). The Property Inspector fetches preset names from WLED devices and displays them in dropdowns instead of raw numeric IDs.

Purpose: Completes the button action set with the most-requested feature — preset activation with user-friendly name display.
Output: Working ActivatePresetAction with PI showing preset names, simple/advanced mode toggle, controller multi-select.
</objective>

<execution_context>
@C:/Users/barlo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/barlo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-actions/02-RESEARCH.md
@.planning/phases/02-actions/02-01-SUMMARY.md

@src/plugin.ts
@src/client/WLEDClient.ts
@src/client/types.ts
@src/actions/TogglePowerAction.ts
@src/registry/ControllerRegistry.ts
@src/registry/types.ts
@ui/toggle-power.html
@manifest.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ActivatePresetAction class with simple and advanced mode</name>
  <files>src/actions/ActivatePresetAction.ts, src/plugin.ts, manifest.json, imgs/actions/activate-preset/icon.png, imgs/actions/activate-preset/key.png</files>
  <action>
1. Create `src/actions/ActivatePresetAction.ts`:

   Define settings interface:
   ```typescript
   interface ActivatePresetSettings {
     controllerIds: string[];
     presetId: number | null;          // simple mode: same preset for all
     advancedMode: boolean;            // whether per-controller mapping is active
     controllerPresets: {              // advanced mode: per-controller preset ID
       [controllerId: string]: number;
     };
   }
   ```

   Use `@action({ UUID: 'com.barloworld.wled.activate-preset' })` decorator.
   Extend `SingletonAction<ActivatePresetSettings>`.

   `onKeyDown`:
   - Destructure settings with defaults: `controllerIds = []`, `presetId = null`, `advancedMode = false`, `controllerPresets = {}`.
   - If `controllerIds` empty, `showAlert()` and return.
   - Resolve controllers via `ControllerRegistry.getInstance().getById()`, filter undefined.
   - If `advancedMode`:
     - Fan out: for each controller, look up `controllerPresets[c.id]`. If no preset mapped for this controller, skip it (do not call setState). Call `WLEDClient.fromHostPort(c.ip).setState({ ps: controllerPresets[c.id] })` for each.
   - If simple mode:
     - If `presetId` is null, `showAlert()` and return (no preset selected).
     - Fan out: `WLEDClient.fromHostPort(c.ip).setState({ ps: presetId })` for all controllers.
   - Use `Promise.allSettled()` for fan-out. If any rejected, `showAlert()`.

   `onPropertyInspectorDidAppear`:
   - Send `{ type: 'init', controllers: registry.getAll(), settings: ev.payload.settings }` via `streamDeck.ui.sendToPropertyInspector` (as-any cast).

   `onSendToPlugin`:
   - `ap:saveSettings`: Receive full `ActivatePresetSettings` and call `ev.action.setSettings()`.
   - `ap:getControllers`: Respond with `{ type: 'controllerList', controllers: registry.getAll() }`.
   - `ap:getPresets`: Receive `{ type: 'ap:getPresets', controllerId: string }`. Look up controller IP from registry, call `WLEDClient.fromHostPort(ip).getPresets()`. Respond with `{ type: 'presetList', controllerId, presets }` via sendToPropertyInspector. Wrap in try/catch — on failure, send `{ type: 'presetList', controllerId, presets: [], error: 'Could not fetch presets' }`.

2. Update `src/plugin.ts`:
   - Import `ActivatePresetAction` from `./actions/ActivatePresetAction`
   - Add `streamDeck.actions.registerAction(new ActivatePresetAction())` before `streamDeck.connect()`
   - The `ap:` namespace prefix guard was already added in Plan 02-01 (generic namespace filter).

3. Update `manifest.json`:
   - Add to `Actions` array:
     ```json
     {
       "Name": "Activate Preset",
       "UUID": "com.barloworld.wled.activate-preset",
       "Icon": "imgs/actions/activate-preset/icon",
       "PropertyInspectorPath": "ui/activate-preset.html",
       "Controllers": ["Keypad"],
       "States": [{ "Image": "imgs/actions/activate-preset/key" }]
     }
     ```

4. Create placeholder PNG icons (same approach as Plan 02-01):
   - `imgs/actions/activate-preset/icon.png` — 20x20 minimal placeholder
   - `imgs/actions/activate-preset/key.png` — 72x72 minimal placeholder
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Verify manifest.json is valid JSON with two entries in Actions array. Verify PNG files exist.</verify>
  <done>ActivatePresetAction registered, handles both simple mode (one preset for all) and advanced mode (per-controller presets). Fetches preset names from WLED on PI request. Fan-out with Promise.allSettled and showAlert on failure.</done>
</task>

<task type="auto">
  <name>Task 2: Create activate-preset Property Inspector HTML with preset dropdowns and advanced mode</name>
  <files>ui/activate-preset.html</files>
  <action>
Create `ui/activate-preset.html` following the same patterns as `ui/toggle-power.html` (from Plan 02-01) and `ui/global-settings.html`:

- Same sdpi-components CDN, same `window.$SD` bridge pattern.
- All messages use `ap:` namespace prefix.

Layout sections:

1. **Target Controllers** — Checkbox multi-select of registered controllers (same pattern as toggle-power.html). Each checkbox `data-controller-id`. On change, auto-save settings AND fetch presets for newly-checked controllers.

2. **Mode Toggle** — A checkbox or toggle labeled "Advanced mode (per-controller presets)". Default off.
   - When OFF (simple mode): show a single "Preset" dropdown populated with preset names from the FIRST selected controller. All controllers get the same preset.
   - When ON (advanced mode): show one "Preset" dropdown PER selected controller, labeled with the controller name. Each dropdown populated with that controller's own preset list.

3. **Preset Dropdown(s)** — `<select>` elements showing `preset.name` as display text and `preset.id` as value.
   - Default option: "-- Select a preset --" with empty value.
   - If fetch fails or returns empty: show "No presets available" as the only disabled option.
   - Pre-select the currently saved preset ID from settings.

Behavior:
- On `websocketCreate`: send `{ type: 'ap:getControllers' }`.
- On `init` message: store controllers and settings, render controller checkboxes, set mode toggle, request presets for all currently selected controllers.
- Request presets: for each selected controller ID, send `{ type: 'ap:getPresets', controllerId }` to plugin.
- On `presetList` message: store `{ controllerId -> presets[] }` in a local map. Re-render preset dropdown(s) with the data. If `error` field present, show the error text.
- On any setting change (controller checkbox, mode toggle, preset dropdown): gather current state and send `{ type: 'ap:saveSettings', controllerIds, presetId, advancedMode, controllerPresets }`.

CSS: Match existing PI aesthetic. Advanced mode section slides in/out (simple `display: none` toggle, no animations). Preset dropdowns use standard `<select>` styled to match sdpi-components look (dark background, light text, same padding).

Edge cases:
- No controllers registered: show "No controllers registered. Add controllers in the global settings panel."
- No controllers selected: hide preset section entirely.
- Controller has no presets: dropdown shows "No presets on this device" as disabled option.
- Advanced mode with one controller: still shows per-controller dropdown (consistent behavior).
  </action>
  <verify>Open the HTML file in a browser to verify DOM structure renders. Verify the file uses ap:-namespaced messages. Check that both simple and advanced mode UI elements exist in the markup.</verify>
  <done>activate-preset.html shows controller multi-select, mode toggle between simple/advanced, and preset name dropdowns populated from WLED devices. Auto-saves all changes to action settings.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` produces `bin/plugin.js` without errors
3. manifest.json has two entries in Actions array (toggle-power and activate-preset)
4. All referenced image paths exist on disk
5. ActivatePresetAction handles both simple and advanced mode in onKeyDown
6. PI fetches preset names via ap:getPresets and displays in dropdowns
7. Advanced mode shows per-controller preset dropdowns
8. Empty/error states handled gracefully in both action and PI
</verification>

<success_criteria>
- ActivatePresetAction compiles and is registered in plugin.ts
- Simple mode: one preset ID applied to all selected controllers via setState({ ps })
- Advanced mode: per-controller preset mapping applied via fan-out
- PI shows preset names (not IDs) fetched from WLED via getPresets()
- PI has working mode toggle between simple and advanced
- Controller multi-select works with auto-save
- Unreachable controllers during key press trigger showAlert()
- Preset fetch failures show graceful error in PI dropdown
- manifest.json declares activate-preset action correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-actions/02-02-SUMMARY.md`
</output>
