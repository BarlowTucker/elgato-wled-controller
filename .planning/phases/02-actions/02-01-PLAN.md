---
phase: 02-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/client/WLEDClient.ts
  - src/client/types.ts
  - src/actions/TogglePowerAction.ts
  - ui/toggle-power.html
  - src/plugin.ts
  - manifest.json
  - imgs/actions/toggle-power/icon.png
  - imgs/actions/toggle-power/key.png
autonomous: true
requirements:
  - BTN-01
  - CTRL-04
  - CTRL-05
  - UI-01

must_haves:
  truths:
    - "User can press a Stream Deck button to toggle power on all selected WLED controllers"
    - "User can select which controllers a toggle-power action targets via checkbox multi-select in the Property Inspector"
    - "When a targeted controller is unreachable, the key shows an alert icon without crashing the plugin"
    - "Toggle Power action appears in the Stream Deck action list with an icon"
  artifacts:
    - path: "src/actions/TogglePowerAction.ts"
      provides: "Toggle power action with fan-out and error handling"
      exports: ["TogglePowerAction"]
    - path: "ui/toggle-power.html"
      provides: "Property Inspector with controller multi-select checkboxes"
      min_lines: 40
    - path: "src/client/WLEDClient.ts"
      provides: "togglePower() and getPresets() methods"
      contains: "togglePower"
    - path: "src/client/types.ts"
      provides: "WLEDPreset type for preset name/id pairs"
      contains: "WLEDPreset"
  key_links:
    - from: "src/actions/TogglePowerAction.ts"
      to: "src/registry/ControllerRegistry.ts"
      via: "ControllerRegistry.getInstance().getById()"
      pattern: "registry\\.getById"
    - from: "src/actions/TogglePowerAction.ts"
      to: "src/client/WLEDClient.ts"
      via: "WLEDClient.fromHostPort().togglePower()"
      pattern: "togglePower"
    - from: "src/actions/TogglePowerAction.ts"
      to: "Promise.allSettled"
      via: "fan-out to all targeted controllers"
      pattern: "Promise\\.allSettled"
    - from: "src/plugin.ts"
      to: "src/actions/TogglePowerAction.ts"
      via: "streamDeck.actions.registerAction()"
      pattern: "registerAction.*TogglePowerAction"
    - from: "manifest.json"
      to: "ui/toggle-power.html"
      via: "PropertyInspectorPath in Actions array"
      pattern: "toggle-power\\.html"
---

<objective>
Add the Toggle Power action — the first button action that lets users toggle WLED power on/off with one keypress targeting multiple controllers. Also extends WLEDClient with togglePower() and getPresets() methods (getPresets needed by Plan 02), creates placeholder action icons, and establishes the per-action PI pattern with controller multi-select.

Purpose: Delivers the core "one button press controls lights" value proposition and establishes patterns for all subsequent actions.
Output: Working TogglePowerAction registered in manifest, with PI for controller selection, fan-out with error handling.
</objective>

<execution_context>
@C:/Users/barlo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/barlo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-actions/02-RESEARCH.md

@src/plugin.ts
@src/client/WLEDClient.ts
@src/client/types.ts
@src/registry/ControllerRegistry.ts
@src/registry/types.ts
@ui/global-settings.html
@manifest.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend WLEDClient with togglePower() and getPresets(), add WLEDPreset type</name>
  <files>src/client/WLEDClient.ts, src/client/types.ts</files>
  <action>
1. Add to `src/client/types.ts`:
   - `WLEDPreset` interface: `{ id: number; name: string }`
   - Do NOT modify existing WLEDState/WLEDInfo/WLEDSegment interfaces

2. Add to `src/client/WLEDClient.ts` two new methods:

   `async togglePower(timeoutMs = 1500): Promise<void>` — POSTs `{ "on": "t" }` to `/json/state` using the WLED toggle shorthand. Note: this bypasses the typed `setState(Partial<WLEDState>)` because `"t"` is a string, not boolean. Use a raw `fetch()` call with `JSON.stringify({ on: "t" })` directly, same pattern as existing `setState` but with the string literal.

   `async getPresets(timeoutMs = 1500): Promise<WLEDPreset[]>` — GETs `/presets.json`, parses the response as `Record<string, { n?: string }>`, filters to numeric keys > 0 (skip key "0" which is a system preset), maps to `{ id: Number(key), name: val.n?.trim() || 'Preset ${key}' }`, sorts by id ascending. Import `WLEDPreset` from `./types`.

Both methods follow the existing error pattern: `if (!response.ok) throw new Error('WLED HTTP ${response.status}')` and use `AbortSignal.timeout(timeoutMs)`.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Inspect the file to confirm both methods exist and follow existing patterns.</verify>
  <done>WLEDClient has togglePower() and getPresets() methods. WLEDPreset type exported from types.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Create TogglePowerAction class, register in plugin.ts, add manifest entry and placeholder icons</name>
  <files>src/actions/TogglePowerAction.ts, src/plugin.ts, manifest.json, imgs/actions/toggle-power/icon.png, imgs/actions/toggle-power/key.png</files>
  <action>
1. Create `src/actions/TogglePowerAction.ts`:
   - Define `TogglePowerSettings` interface: `{ controllerIds: string[] }`
   - Use `@action({ UUID: 'com.barloworld.wled.toggle-power' })` decorator
   - Extend `SingletonAction<TogglePowerSettings>`
   - `onKeyDown`: Destructure `controllerIds` with default `[]`. If empty, call `ev.action.showAlert()` and return. Otherwise resolve controllers via `ControllerRegistry.getInstance().getById()`, filter out undefined. Fan out `WLEDClient.fromHostPort(c.ip).togglePower()` via `Promise.allSettled()`. If any result has `status === 'rejected'`, call `ev.action.showAlert()`.
   - `onPropertyInspectorDidAppear`: Send `{ type: 'init', controllers: registry.getAll(), settings: ev.payload.settings }` to PI via `streamDeck.ui.sendToPropertyInspector` (with as-any cast per Phase 1 pattern).
   - `onSendToPlugin`: Handle `{ type: 'tp:saveSettings', controllerIds: string[] }` — call `ev.action.setSettings({ controllerIds })`. Use the `tp:` namespace prefix to avoid collision with the global PI handler. Handle `{ type: 'tp:getControllers' }` — respond with `{ type: 'controllerList', controllers: registry.getAll() }` via sendToPropertyInspector.
   - Import: `streamDeck, { action, SingletonAction }` from `@elgato/streamdeck`, types from SDK, `ControllerRegistry`, `WLEDClient`, `WLEDController` type.

2. Update `src/plugin.ts`:
   - Import `TogglePowerAction` from `./actions/TogglePowerAction`
   - Add `streamDeck.actions.registerAction(new TogglePowerAction())` BEFORE `streamDeck.connect()` call
   - Add a guard at the top of the existing `streamDeck.ui.onSendToPlugin` handler to skip messages with namespaced types (those starting with `tp:` or `ap:`) — these are handled by the SingletonAction subclass override, not the global handler. Add a comment explaining why.

3. Update `manifest.json`:
   - Add to `Actions` array:
     ```json
     {
       "Name": "Toggle Power",
       "UUID": "com.barloworld.wled.toggle-power",
       "Icon": "imgs/actions/toggle-power/icon",
       "PropertyInspectorPath": "ui/toggle-power.html",
       "Controllers": ["Keypad"],
       "States": [{ "Image": "imgs/actions/toggle-power/key" }]
     }
     ```

4. Create placeholder PNG icons:
   - `imgs/actions/toggle-power/icon.png` — 20x20 white circle on transparent background (for action list). Generate with Node.js: create a minimal valid PNG programmatically, or use a simple 1-pixel transparent PNG as placeholder. The simplest approach: use a base64-encoded minimal 20x20 PNG and write it with `Buffer.from(base64, 'base64')`.
   - `imgs/actions/toggle-power/key.png` — 72x72 white circle on transparent (for key display). Same approach.
   - These are development placeholders — Phase 4 will produce final artwork.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Verify manifest.json is valid JSON with `node -e "JSON.parse(require('fs').readFileSync('manifest.json','utf8'))"`. Verify PNG files exist at expected paths.</verify>
  <done>TogglePowerAction registered in plugin.ts, declared in manifest.json Actions array, placeholder icons exist. Action fans out togglePower to all selected controllers with Promise.allSettled error handling.</done>
</task>

<task type="auto">
  <name>Task 3: Create toggle-power Property Inspector HTML with controller multi-select</name>
  <files>ui/toggle-power.html</files>
  <action>
Create `ui/toggle-power.html` following the pattern established in `ui/global-settings.html`:
- Load sdpi-components.js from the same CDN URL used in global-settings.html: `https://sdpi-components.dev/releases/v4/sdpi-components.js`
- Use the same `window.$SD` event bridge pattern from global-settings.html (NOT the SDPIComponents.streamDeckClient pattern from the research — the existing codebase uses `window.$SD.send('sendToPlugin', ...)` and `window.$SD.on('sendToPropertyInspector', ...)`).

Layout:
1. A "Target Controllers" section showing checkboxes for each registered controller (name + IP). Each checkbox has `data-controller-id` attribute with the controller UUID.
2. A "No controllers registered" message if the list is empty, with hint to add via global settings.
3. Changes auto-save: when any checkbox changes, immediately send `{ type: 'tp:saveSettings', controllerIds: [checkedIds] }` to the plugin. No explicit save button needed.

Behavior:
- On DOMContentLoaded AND on `websocketCreate` event: send `{ type: 'tp:getControllers' }` to plugin.
- The action's `onPropertyInspectorDidAppear` sends an `init` message with controllers + current settings.
- Listen for `sendToPropertyInspector` messages:
  - `type: 'init'`: Store controllers array and settings. Render checkboxes. Pre-check boxes matching `settings.controllerIds`.
  - `type: 'controllerList'`: Re-render checkboxes with updated list, preserving checked state from current settings.
- Use the same `escHtml()` helper from global-settings.html for safe rendering.

Style: Minimal CSS matching the global-settings.html aesthetic (same font sizes, opacity patterns). Checkbox labels show controller name bold, IP in smaller muted text below.
  </action>
  <verify>Open the HTML file in a browser to check it loads without JS errors (sdpi-components will fail to connect but the DOM structure should render). Verify the file references the correct sdpi-components CDN URL.</verify>
  <done>toggle-power.html renders controller checkboxes, auto-saves on change, communicates with plugin via tp:-namespaced messages using the $SD bridge pattern.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` (or `npx rollup -c`) produces `bin/plugin.js` without errors
3. manifest.json is valid JSON with one entry in Actions array
4. All referenced image paths exist on disk
5. TogglePowerAction is imported and registered in plugin.ts before connect()
6. WLEDClient.togglePower() and getPresets() methods exist
7. Global onSendToPlugin handler skips tp:-namespaced messages
</verification>

<success_criteria>
- TogglePowerAction class compiles, is registered, and fans out togglePower() to all targeted controllers via Promise.allSettled()
- toggle-power.html renders controller multi-select checkboxes and auto-saves selections
- Unreachable controllers trigger showAlert() without crashing
- Empty controllerIds triggers showAlert() on key press
- manifest.json declares the action with correct UUID, icon paths, and PI path
- WLEDClient has both togglePower() and getPresets() methods ready for Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/02-actions/02-01-SUMMARY.md`
</output>
